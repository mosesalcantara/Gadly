<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  {% load static %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <link rel="apple-touch-icon" sizes="76x76" href="{% static 'img/apple-icon.png' %}">
  <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
  <title>Gadly</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="{% static 'css/nucleo-icons.css' %}" rel="stylesheet" /> 
  <link href="{% static 'css/nucleo-svg.css' %}" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="{% static 'css/nucleo-svg.css' %}" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="{% static 'css/argon-dashboard.css' %}" rel="stylesheet" /> 
  <style>
    #myProgress {
      width: 100%;
      background-color: #ddd;
    }
    #myBar {
      width: 1%;
      height: 30px;
      background-color: #04AA6D;
    }
    .glass {
      background-color: rgba(255, 255, 255, 0.45);
      backdrop-filter: blur(15px);
      box-shadow: 0 0 10px 1px rgb(0 0 0 / 25%);
      color:rgb(0, 0, 0);
      font-size: 20px;
    }
    .glass-sidebar{
      background-color: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      box-shadow: 0 0 10px 1px rgb(0 0 0 / 25%);
    }
    .theme-color {
      background-image: linear-gradient(#CB5CBA, #824AB5);
    }
  </style>
</head>

<body class="g-sidenav-show   bg-gray-100">
  {% include './includes/sidebar.html' %}
  <main class="main-content position-relative border-radius-lg ">
    <!-- Navbar -->
    {% include './includes/navbar.html' %}
    <!-- End Navbar -->
    <div class="container-fluid py-1">
      <!---->
      <div class="row">
        <div class="col-12">
          <div class="card z-index-2 glass">
            <div class="card-header pb-0 pt-3 bg-transparent">
              <h6 class="text-capitalize">Type Your Phrase Here</h6>
              <form action="/backend/upl_file/" style="display: none;" id="upl_form" enctype="multipart/form-data">
                <input type="file" id="file" name="file">
              </form>
              <div>
                <span><i class="fa-solid fa-microphone fa-fw" title="Speech Recognition" onclick="runSpeechRecognition()" style="cursor: pointer; margin-right: 10px;"></i></span>
                <span><i class="fa-solid fa-file-arrow-up fa-fw" title="Upload File" id="upl_open" style="cursor: pointer; margin-right: 10px;"></i></span>
                <span><i class="fa-solid fa-clipboard fa-fw" title="Copy to Clipboard" onclick="copy_text()" style="cursor: pointer;"></i></span>
                <span id="action"></span>
              </div>
            </div>
            <div class="card-body p-3" style="overflow:auto;height:30vh;" contenteditable="true" id="input">
            </div>
            <div class="card-footer">
              <p id="word_count" class="d-inline" style="margin-right: 66vw;">0/250 words</p>
              <button class="btn btn-primary d-inline-flex align-items-center" id="checkPlag">
                <span class="spinner-border spinner-border-sm text-info mr-2 p-r-4" role="status" id ="spinner" style="display: none;"></span>
                <span class="ml-auto" id="Check_Plagiarism">Check Plagiarism</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-4">
          <div class="card glass">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Plagiarized</p>
                    <h5 class="font-weight-bolder" id="plag_per"></h5>
                    <p class="mb-0">
                      <span class="text-danger text-sm font-weight-bolder"></span>
                    </p>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-4">
          <div class="card glass">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Unique</p>
                    <h5 class="font-weight-bolder" id="uniq_per"></h5>
                    <p class="mb-0">
                      <span class="text-danger text-sm font-weight-bolder"></span>
                    </p>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-4">
          <div class="card glass">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Sources</p>
                    <h5 class="font-weight-bolder" id="src_count"></h5>
                    <p class="mb-0">
                      <span class="text-danger text-sm font-weight-bolder"></span>
                    </p>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-info shadow-info text-center rounded-circle"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-3" style="display: none;" id="sources_div">
        <div class="card glass">
          <div class="card-body" id="sources_tbl">
          </div>
        </div>
      </div>
      
      {% include './includes/footer.html' %} 
    </div>
  </main>
  {% include './includes/settings.html' %} 
  <!--   Core JS Files   -->
  <script src="{% static 'js/core/popper.min.js' %}"></script>
  <script src="{% static 'js/core/bootstrap.min.js' %}"></script>
  <script src="{% static 'js/plugins/perfect-scrollbar.min.js' %}"></script>
  <script src="{% static 'js/plugins/smooth-scrollbar.min.js' %}"></script>
  <script src="{% static 'js/plugins/chartjs.min.js' %}"></script>
  
  <script>
    $(document).ready(function() {  
      $('#input').text('') 
      $('#input').keyup(function(e){ check_wordcount(e); });
      $('#input').keydown(function(e){ check_wordcount(e); });

      input_area = document.getElementById('input')
      input_area.addEventListener('paste', function (e) {
        e.preventDefault()
        var text = (e.originalEvent || e).clipboardData.getData('text/plain')
        document.execCommand('insertText', false, text)
      })

      $("#upl_open").click(function(event){
        $('#file').trigger('click');
      })

      document.getElementById("file").onchange = function() {
        $("#upl_form").submit()
      };

      $("#upl_form").on('submit', function(e){
        e.preventDefault();
        $.ajax({
          type: 'POST',
          url: '/backend/upl_file/',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data: new FormData(this),
          dataType: 'json',
          contentType: false,
          cache: false,
          processData:false,
          success: function(res){
            var txt = res.txt
            $('#input').empty()
            $('#input').html(txt)
            check_wordcount()
          }
        })
      })

      $("#checkPlag").click(function(event){
        $("#spinner").attr("style", "display:inline")
        var txt = $("#input").text()

        $('#plag_per').html('')
        $('#uniq_per').html('')
        $('#src_count').html('')
        $('#sources_tbl table').remove()

        $.ajax( {
          method:"POST",
          url:'/backend/check_plag/',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data:{
            txt:txt
          },
          success:function(data) {
            $("#spinner").attr("style", "display:none")

            if (data.code == 200){
              res = data.response
              var plag_per = res['plagPercent']
              var uniq_per = res['uniquePercent']
              
              $('#plag_per').html(plag_per+'%')
              $('#uniq_per').html(uniq_per+'%')

              var sources = res['sources']
              $('#src_count').html(sources.length)

              if (sources.length > 0) {
                var tbl = $('<table>').addClass('table table-light w-100')

                var thr = $('<tr>')
                thr.append($('<th>').text('Sources'))
                thr.append($('<th>').text('Percent'))
                tbl.append(thr);

                for (source of sources){
                  var tr = $('<tr>');
                  tr.append($('<td>').text(source['link']));
                  tr.append($('<td>').text(`${source['percent']}%`));
                  tbl.append(tr);
                }
                $('#sources_tbl').append(tbl)
                $('#sources_div').css('display', 'block')
              }
            }
          }
        })
      })
    })

    function copy_text(){
      var txt = $('#input').text()
      // console.log(output)
      navigator.clipboard.writeText(txt)
      $('#copied').text(' Copied')
      setTimeout(() => {
        $('#copied').text('')
      }, 3000)
    }

    function check_wordcount(e){
      var inp = document.getElementById('input')
      var str = $('#input').text();
      var words = str.split(' ');
      var max = 250
      
      if (words[0] == ''){
        $('#word_count').text("0/250 words")   
      }
      else if (words.length < max){
        $('#word_count').text(`${words.length}/${max} words`)   
      }
      else if (words.length >= max){
        str_max = words.slice(0,max).join(" ")
        $('#word_count').text(`${max}/${max} words`)  
        $('#input').text(str_max)
        inp.focus()
        window.getSelection().selectAllChildren(inp)
        window.getSelection().collapseToEnd()
      }
    }

    function runSpeechRecognition() {
      var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition
      var recognition = new SpeechRecognition()
  
      recognition.onstart = function() {
        $('#action').html(" <small>listening, please speak...</small>")
      };
      
      recognition.onspeechend = function() {
        $('#action').html(" <small>stopped listening, hope you are done...</small>")
        setTimeout(() => {
          $('#action').html('')
        }, 3000)
        recognition.stop()
      }
    
      recognition.onresult = function(event) {
        var transcript = event.results[0][0].transcript
        $('#input').html(transcript)
      };
    
      recognition.start();
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
  
  <script src="{% static 'js/argon-dashboard.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
</body>
</html>
