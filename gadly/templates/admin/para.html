<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  {% load static %}
  <link rel="apple-touch-icon" sizes="76x76" href="{% static 'img/apple-icon.png' %}">
  <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
  <title>Gadly</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="{% static 'css/nucleo-icons.css' %}" rel="stylesheet" /> 
  <link href="{% static 'css/nucleo-svg.css' %}" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="{% static 'css/nucleo-svg.css' %}" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="{% static 'css/argon-dashboard.css' %}" rel="stylesheet" /> 
  <style>
    #myProgress {
      width: 100%;
      background-color: #ddd;
    }
    #myBar {
      width: 1%;
      height: 30px;
      background-color: #04AA6D;
    }
    .glass {
      background-color: rgba(255, 255, 255, 0.45);
      backdrop-filter: blur(15px);
      box-shadow: 0 0 10px 1px rgb(0 0 0 / 25%);
    }
    .glass-sidebar{
      background-color: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      box-shadow: 0 0 10px 1px rgb(0 0 0 / 25%);
    }
    .theme-color {
      background-image: linear-gradient(#CB5CBA, #824AB5);
    }
    .highlight{
      color: #f54c49;
    }
    .dropbtn {
      cursor: pointer;
    }
    .drop {
      position: relative;
      display: inline-block;
    }
    .drop-con {
      display: none;
      position: absolute;
      background-color: white;
      box-shadow: rgb(0 0 0 / 20%) 0px 4px 22px 0px;
      min-width: 100px;
      z-index: 1;
    }
    .drop-con a {
      color: black;
      padding: 12px 16px;
      display: block;
    }
    .drop-con a:hover {
      background-color: #ddd;
      cursor: pointer;
    }
    .show {
      display:block;
    }
  </style>
</head>

<body class="g-sidenav-show   bg-gray-100">
  {% include './includes/sidebar.html' %}
  <main class="main-content position-relative border-radius-lg ">
    <!-- Navbar -->
    {% include './includes/navbar.html' %}
    <!-- End Navbar -->
    <div class="container-fluid py-4">
      <!---->
      <div class="row">
        <div class="col-lg-7 mb-lg-0">
          <div class="card z-index-2 glass">
            <div class="card-header pb-0 pt-3 bg-transparent">
              <h6 class="text-capitalize">Type Your Phrase Here</h6>
              <form action="backend/upl_file/" style="display: none;" id="upl_form" enctype="multipart/form-data">
                <input type="file" id="file" name="file">
              </form>
              <p>
                <i class="fa-solid fa-microphone" onclick="runSpeechRecognition()" style="cursor: pointer;" title="Speech Recognition"></i><span id="action"></span>
                <i class="fa-solid fa-file-arrow-up" aria-hidden="true" title="Upload File" id="upl_open" style="cursor: pointer;"></i>
              </p>
              <button class="btn btn-primary d-inline-flex align-items-center" id="neutralize">
                <span class="spinner-border spinner-border-sm text-info mr-3 p-r-4" role="status" id ="neutralize_spinner" style ="display: none;"></span>
                <span class="ml-auto"> Gender Neutralize</span>
              </button>
              <button class="btn btn-primary d-inline-flex align-items-center" id="paraphrase" style="margin-left: 1vh;">
                <span class="spinner-border spinner-border-sm text-info mr-3 p-r-4" role="status" id ="paraphrase_spinner" style ="display: none;"></span>
                <span class="ml-auto"> Paraphrase</span>
              </button>
            </div>
            <div class="card-body p-3" style="overflow:auto;height:47vh;" contenteditable="true" id="input">
            </div>
            <div id="word_count">0/250 words</div>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="card overflow-hidden h-100 glass">
            <div class="card-header pb-0 pt-3 bg-transparent">
              <h5 style="float:right; font-size:20px; margin-right:20px;">Rephrased</h5><br>
              <p><i class="fa-regular fa-clipboard" onclick="copy_text()" style="cursor: pointer;" title="Copy to Clipboard"></i><span id="copied"></span></p>
              <div id="myProgress1">
                <div id="myBar1"></div>
              </div>
            </div>
            <div class="card-body p-3" style="overflow:auto;height:47vh;" id="output">
            </div>
            <div id="myProgress">
              <div id="myBar"></div>
            </div>
          </div>
        </div>
        </div>
        <div class="row mt-3">
          <div class="col-4 mb-xl-0">
            <div class="card glass">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-8">
                    <div class="numbers">
                      <p class="text-sm mb-0 text-uppercase font-weight-bold">Synonyms</p>
                      <h5 id="synonyms" class="font-weight-bolder"></h5>
                      <p class="mb-0">
                        <span class="text-success text-sm font-weight-bolder"></span>
                      </p>
                    </div>
                  </div>
                  <div class="col-4 text-end">
                    <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-4 mb-xl-0">
            <div class="card glass">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-8">
                    <div class="numbers">
                      <p class="text-sm mb-0 text-uppercase font-weight-bold">Replaced Words</p>
                      <h5 id="replaced" class="font-weight-bolder"></h5>
                      <p class="mb-0">
                      </p>
                    </div>
                  </div>
                  <div class="col-4 text-end">
                    <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card glass">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-8">
                    <div class="numbers">
                      <p class="text-sm mb-0 text-uppercase font-weight-bold">Structural Changes</p>
                      <h5 class="font-weight-bolder" id="diff">

                      </h5>
                      <p class="mb-0">
                        <span class="text-success text-sm font-weight-bolder"></span>
                      </p>
                    </div>
                  </div>
                  <div class="col-4 text-end">
                    <div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% include './includes/footer.html' %} 
    </div>
  </main>
  {% include './includes/settings.html' %} 
  <!--   Core JS Files   -->
  <script src="{% static 'js/core/popper.min.js' %}"></script>
  <script src="{% static 'js/core/bootstrap.min.js' %}"></script>
  <script src="{% static 'js/plugins/perfect-scrollbar.min.js' %}"></script>
  <script src="{% static 'js/plugins/smooth-scrollbar.min.js' %}"></script>
  <script src="{% static 'js/plugins/chartjs.min.js' %}"></script>
  
  <script>
    var words_list=[]
    var rep_dict = {}

    $(document).ready(function() {  
      $('#input').text('') 
      $('#input').keyup(function(e){ check_wordcount(e); });
      $('#input').keydown(function(e){ check_wordcount(e); });

      var b = document.getElementById("myBar");
      b.style.width = 0 + "%"
      
      input_area = document.getElementById('input')
      input_area.addEventListener('paste', function (e) {
        e.preventDefault()
        var text = (e.originalEvent || e).clipboardData.getData('text/plain')
        document.execCommand('insertText', false, text)
      })

      $("#paraphrase").click(function(event){
        $("#paraphrase_spinner").attr("style", "display:inline")
        $('#output').html('') 
        $('#difference').empty()
        var txt = $("#input").text()
        var bar = document.getElementById("myBar");
        bar.style.width = 5 + "%"
        $.ajax( {
          method:"POST",
          url:'/backend/paraphrase/',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data:{
            txt:txt
          },
          success:function(data) {
            $("#paraphrase_spinner").attr("style", "display:none")
            var i = 0;
            if (i == 0) {
              i = 1;
              var elem = document.getElementById("myBar");
              var width = 1;
              var id = setInterval(frame, 10);

              var sen = data.sentence
              $('#output').text(sen) 

              function frame() {
                if (width >= 100) {
                  clearInterval(id);
                  i = 0;
                } else {
                  width = width+10;
                  elem.style.width = width + "%";
                }
              }
            }
            
            var output = $('#output').clone().find('.drop-con').remove().end().text()
            struct_changes(txt, output)
          }
        });
      });

      $("#neutralize").click(function(event){
        $("#neutralize_spinner").attr("style", "display:inline")
        $('#output').html('') 
        $('#difference').empty()
        var txt = $("#input").text()
        var bar = document.getElementById("myBar");
        bar.style.width = 5 + "%"
        $.ajax( {
          method:"POST",
          url:'/backend/para_txt/',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data:{
            txt:txt
          },
          success:function(data) {
            $("#neutralize_spinner").attr("style", "display:none")
            var i = 0;
            if (i == 0) {
              i = 1;
              var elem = document.getElementById("myBar");
              var width = 1;
              var id = setInterval(frame, 10);
              paraphrase(data)

              function frame() {
                if (width >= 100) {
                  clearInterval(id);
                  i = 0;
                } else {
                  width = width+10;
                  elem.style.width = width + "%";
                }
              }
            }
            
            var output = $('#output').clone().find('.drop-con').remove().end().text()
            struct_changes(txt, output)
          }
        });
      });

      $("#upl_open").click(function(event){
        $('#file').trigger('click');
      })

      document.getElementById("file").onchange = function() {
        $("#upl_form").submit()
      };

      $("#upl_form").on('submit', function(e){
        e.preventDefault();
        $.ajax({
          type: 'POST',
          url: '/backend/upl_file/',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          data: new FormData(this),
          dataType: 'json',
          contentType: false,
          cache: false,
          processData:false,
          success: function(res){
            var txt = res.txt
            $('#input').empty()
            $('#input').html(txt)
            check_wordcount()
          }
        })
      })

      $("#sign_out").click(function(event){
        data = {
          "reps" : rep_dict
        }
        data['reps'] = JSON.stringify(data['reps'])
        $.ajax( {
          method:"POST",
          url:'/admin/logout/',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          dataType:'JSON',
          data:data,
          success:function(data){
            window.location.replace("/acc")
          }
        });
      });
    });

    function struct_changes(txt, output){
      // console.log(txt, output)
      $.ajax( {
        method:"POST",
        url:'/backend/struct_changes/',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        },
        data:{
          txt:txt,
          output:output
        },
        success:function(data) {
          var diff = data.diff
          // console.log(difference)
          $('#diff').html(diff+'%')            
        }
      });
    }

    function paraphrase(data){
      console.log(data)
      var syn_count=0
      var rep_count=0
      var ind = 0
      var punct=['.',',']
      var prev = ''

      words_list=data.words_list
      words=data.words
      rep_dict=data.words_data.rep_dict

      words_list.forEach(function (ent, ind) {
        rep_count++
        det = Object.keys(ent)[0]
        for (let synos in words_list[ind][det]){
          for (let syn of synos){
            syn_count++
          }
        }
      })

      $('#synonyms').text(syn_count)
      $('#replaced').text(rep_count)

      var out = $('#output')
      // console.log(words)
      while (ind < words.length){
        word = words[ind]
        cap_test = check_cap(ind, prev)
        syns = check_word(word)
        if (cap_test){
          word = capitalize(word)
        }
        if (syns.length > 0){
          // console.log(`Word:${word}`)
          drop = $(`<div class='drop'></div>`)
          out.append(drop)
          det = get_det(word.toLowerCase())
          span = $(`<span class='highlight dropbtn' data-det=${det}>${word}</span>`)
          if (word.includes('_')){
            word = word.replace('_',' ')
            span.html(word)
          }
          span.on("click",show_dropcon)
          drop.append(span)
          drop_con = $(`<div class='drop-con'></div>`)
          drop.append(drop_con)
          for (syn of syns){
            // console.log(`Syn:${syn}`)
            var rep = syn
            if (cap_test){
              syn=capitalize(syn)
            }
            a = $(`<a style=color:#7267e4; data-rep=${rep}>${syn}</a>`)
            if (syn.includes('_')){
              syn = syn.replace('_',' ')
              a.text(syn)
            }
            a.on("click",replace_word)
            drop_con.append(a)
          }
        }
        else{
          con = out.append(`${word}`)
        }
        if (punct.includes(words[++ind]) == false){
          out.append(' ')
        }
        prev = word
        cap_test = false
      }
    }

    function check_word(word){
      var word_syns = []
      words_list.forEach(function (ent, ind) {
        det = Object.keys(ent)[0]
        if (word == words_list[ind][det][0]){
          word_syns = words_list[ind][det]
        }
      })
      return word_syns
    }

    function check_cap(ind,prev){
      if (ind == 0 || prev == '.'){
        return true
      }
      else{
        return false
      }
    }

    function capitalize(word){
      var word = word.charAt(0).toUpperCase() + word.slice(1);
      return word
    }

    function get_det(word){
      // console.log(rep_dict)
      for (let det in rep_dict){
        if (rep_dict[det] == word){
          return det
        }
      }
      return word
    }

    function show_dropcon(e){
      $(e.target).next().toggleClass("show")
    }

    function replace_word(e){
      var a = $(e.target)
      // console.log(a)
      var span = $(e.target).parent().prev()
      rep_dict[span.data('det').toLowerCase()] = a.data('rep').toLowerCase()
      span.text(a.text())
    }

    function check_wordcount(e){
      var inp = document.getElementById('input')
      var str = $('#input').text();
      var words = str.split(' ');
      var max = 250
      
      if (words[0] == ''){
        $('#word_count').text("0/250 words")   
      }
      else if (words.length < max){
        $('#word_count').text(`${words.length}/${max} words`)   
      }
      else if (words.length >= max){
        str_max = words.slice(0,max).join(" ")
        $('#word_count').text(`${max}/${max} words`)  
        $('#input').text(str_max)
        inp.focus()
        window.getSelection().selectAllChildren(inp)
        window.getSelection().collapseToEnd()
      }
    }

    function runSpeechRecognition() {
      var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition
      var recognition = new SpeechRecognition()
  
      recognition.onstart = function() {
        $('#action').html(" <small>listening, please speak...</small>")
      };
      
      recognition.onspeechend = function() {
        $('#action').html(" <small>stopped listening, hope you are done...</small>")
        setTimeout(() => {
          $('#action').html('')
        }, 3000)
        recognition.stop()
      }
    
      recognition.onresult = function(event) {
        var transcript = event.results[0][0].transcript
        $('#input').html(transcript)
      };
    
      recognition.start();
    }

    function copy_text(){
      var output = $('#output').clone().find('.drop-con').remove().end().text()
      // console.log(output)
      navigator.clipboard.writeText(output)
      $('#copied').text(' Copied')
      setTimeout(() => {
        $('#copied').text('')
      }, 3000)
    }

    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }

    window.onclick = function(event) {
      if (!event.target.matches('.dropbtn')) {
        var dropdowns = document.getElementsByClassName("drop-con");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
              openDropdown.classList.remove('show');
          }
        }
      }
    }

  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="{% static 'js/argon-dashboard.min.js' %}"></script>
</body>
</html>
